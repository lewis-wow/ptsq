# Middlewares

```ts title="server.ts"
import { createServer, expressAdapter, ExpressAdapterContext } from '@ptsq/server';
import express from 'express';
import { z } from 'zod';
import { userRouter } from './userRouter';
import { getUserFromJWT } from './getUserFromJWT';

const app = express();

const createContext = async ({ req, res }: ExpressAdapterContext) => {
  const user = await getUserFromJWT(req.cookies.jwt);

  return {
    req,
    res,
    user,
  };
};

const { middleware, resolver, router, serve } = createServer({
  ctx: createContext,
});

const isAuthed = middleware(({ ctx, next }) => {
  if (!ctx.user) throw new Error('Must be logged in!');

  return next({
    ctx: {
      user: ctx.user,
    },
  });
});

const protectedResolver = resolver.use(isAuthed);

resolver.query({
  resolve: async ({ ctx /* { user: User | null } */, input /* undefined */ }) => {
    return `Hello, ${ctx.user.name}`;
    // throws Error user can be null
  },
});

protectedResolver.query({
  resolve: async ({ ctx /* { user: User } */, input /* undefined */ }) => {
    return `Hello, ${ctx.user.name}`;
  },
});
```

## Middleware pipes

```ts title="server.ts"
const isAuthed = middleware(({ ctx /* { user: User<any> | null } */, next }) => {
  if (!ctx.user) throw new Error('Must be logged in!');

  return next({
    ctx: {
      user: ctx.user,
    },
  });
});

const isAdmin = isAuthed.pipe(({ ctx /* { user: User<any> } */, next }) => {
  if (ctx.user.role !== 'admin') throw new Error('Must be an admin!');

  return next({
    ctx: {
      user: ctx.user,
    },
  });
});

const adminResolver = resolver.use(isAdmin);

const deleteOrganization = adminResolver.mutation({
  //...
  resolve: ({ ctx /* { user: User<'admin'> } */, input }) => {
    //...
  },
});
```
